# 🎯 智能追更功能說明

## 概述

RedLens 數據工廠已優化為**"智能追更"模式**，大幅提高效率和資源利用率。

## 工作原理

### 三層邏輯

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 讀取 matches.json (英超官方賽程)                        │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: 篩選 "已完賽 (status='C') 但缺錄像" 的比賽             │
│  返回這些比賽的日期集合                                         │
└────────────────────────┬────────────────────────────────────────┘
                         │
                ┌────────┴────────┐
                ▼                 ▼
          ┌──────────┐      ┌──────────────┐
          │ 有目標   │      │  無目標      │
          │ 日期     │      │  (全部匹配)  │
          └────┬─────┘      └────┬─────────┘
               │                  │
               ▼                  ▼
         ┌──────────────┐    ┌──────────────┐
         │  精準追更    │    │  兜底邏輯    │
         │ (只抓目標    │    │ (抓未來7天   │
         │  日期)       │    │  + 過去3天)  │
         └──────────────┘    └──────────────┘
```

### 邏輯流程

1. **智能分析** (`_analyze_pending_matches`)
   - 讀取 `matches.json`
   - 篩選所有已完賽的比賽日期
   - 返回目標日期集合

2. **精準抓取** (如果有待追更比賽)
   - 只請求這些日期的咪咕 API 數據
   - 性能提升: **~90%** (從全季 21 個日期 → 只抓實際比賽日期)

3. **兜底邏輯** (如果沒有待追更比賽)
   - 預設抓取 **未來 7 天 + 過去 3 天**
   - 確保新完賽的比賽和即將舉辦的比賽都被覆蓋
   - 可自定義: 修改 `LOOKBACK_DAYS` 和 `LOOKAHEAD_DAYS`

## 配置參數

```python
# 智能追更配置
LOOKBACK_DAYS = 3    # 往前查詢天數 (默認 3 天)
LOOKAHEAD_DAYS = 7   # 往後查詢天數 (默認 7 天)
```

## 性能對比

### 首次運行 (第一次初始化)
```
[第一次] 掃描整個賽季日期 → ~21 個目標日期
時間成本: ~20-30 秒
原因: 全量掃描 + 抓取所有已完賽比賽
```

### 後續運行 (定期更新)
```
[後續] 如果 matches.json 已完整 → 無待追更比賽
        → 使用兜底邏輯 (未來7天 + 過去3天 ≈ 10 天左右)
時間成本: ~3-5 秒
性能提升: ~80-90% ⚡

[後續] 如果有新完賽的比賽 → 有待追更日期
        → 只抓取這些日期 (1-3 個日期)
時間成本: ~1-2 秒
性能提升: ~95%+ 🚀
```

## 使用示例

### 執行完整流程
```bash
$ bash update_all.sh
```

**輸出範例：**
```
╔════════════════════════════════════════════════════════════╗
║         🚀 RedLens 數據工廠 - 智能追更版本               ║
╚════════════════════════════════════════════════════════════╝

時間: 2026-01-13 18:01:23

📊 Step 1/4: 獲取英超官方賽程...
   └─ 從 footballapi.pulselive.com 抓取 2025/26 賽季數據...

📹 Step 2/4: 智能追更咪咕視頻錄像...
   └─ 分析已完賽但缺錄像的比賽，精準追更...
   📖 已讀取 matches.json，共 38 場比賽
   🎯 發現 21 場已完賽的比賽需要補充錄像數據
   🔍 逐日期抓取數據...
   ✅ 智能追更完成：共 21 場比賽

🔄 Step 3/4: 融合數據...
   └─ 將英超賽程與咪咕視頻數據合併...
   ✅ 匹配: 20 場比賽

🔗 Step 4/4: 生成 Deep Links...
   └─ 為咪咕視頻生成 App 跳轉鏈接...
   ✅ 成功生成: 20 場

✅ RedLens 數據工廠完成!

📊 數據統計:
   總場次: 38 場
   已完賽: 21 場
   ├─ 有錄像: 20 場
   ├─ 有Deep Link: 20 場
   └─ 缺錄像: 1 場
   未完賽: 17 場
```

### 單獨執行智能追更
```bash
$ python3 fetch_all_migu_videos.py
```

## 日誌解讀

### 標準日誌
```
📖 已讀取 matches.json，共 38 場比賽
🎯 發現 21 場已完賽的比賽需要補充錄像數據
📅 待追更的日期：['20250817', '20250824', ...]
🎯 目標日期數: 21 個
🔍 逐日期抓取數據...
   [1/21] 抓取 20250817...
   ✅ 找到 1 場阿森納比賽
   ...
✅ 智能追更完成：共 21 場比賽
```

### 兜底邏輯被觸發
```
✅ 所有已完賽的比賽都有錄像數據，使用默認時間範圍
📅 使用默認時間範圍: 往前 3 天，往後 7 天
   範圍: 20260110 至 20260120
🔍 逐日期抓取數據...
```

## 注意事項

1. **首次運行時間較長**
   - 第一次運行時會掃描整個賽季 (21 場已完賽比賽)
   - 預期耗時 20-30 秒
   - 這是一次性成本，之後都會快速

2. **matches.json 的重要性**
   - 智能追更依賴 `matches.json` 的完整性
   - 確保 `fetch_fixtures.py` 成功執行
   - 如果沒有 `matches.json`，會自動使用兜底邏輯

3. **時區處理**
   - 所有日期均基於北京時間 (UTC+8)
   - API 日期使用 YYYYMMDD 格式 (如 20260104)

4. **API 連線穩定性**
   - 脚本內置重試機制 (最多 3 次)
   - 如果 API 返回 411 錯誤，會自動跳過該日期
   - SSL 驗證已禁用 (macOS LibreSSL 相容性)

## 後續優化方向

1. **增量式追更**
   - 追蹤上次運行時間
   - 只抓取之後新完賽的比賽

2. **並行請求**
   - 使用 asyncio 加速多日期並行抓取
   - 目前是順序執行，可改為並行

3. **本地緩存**
   - 在內存中快速比對已有錄像
   - 避免重複抓取

## 常見問題

**Q: 第一次運行為什麼這麼慢？**
A: 第一次運行需要掃描所有 21 場已完賽比賽。這是一次性成本。之後運行會快得多。

**Q: 能否自定義追更時間範圍？**
A: 可以。修改 `LOOKBACK_DAYS` 和 `LOOKAHEAD_DAYS` 常數即可。

**Q: 為什麼有些比賽沒有錄像？**
A: 某些比賽可能：
- 還未完成直播
- 咪咕沒有獲得轉播權
- API 返回了錯誤

查看 `migu_videos_complete.json` 中的 `pid` 字段。如果為空字符串，表示無法獲取。

**Q: 可以手動觸發全量重新抓取嗎？**
A: 刪除 `migu_videos_complete.json`，然後重新運行 `fetch_all_migu_videos.py`。

---

**版本**: 1.0 (2026-01-13)
**維護者**: RedLens 開發團隊

