name: æ¯æ—¥æ›´æ–°æ¯”èµ›æ•°æ® (Data Factory)

on:
  schedule:
    # --- ğŸŸ¢ æ—¥å¸¸å·¡æ£€ (ä½é¢‘ä¿æ´») ---
    # åŒ—äº¬æ—¶é—´: 08:00, 14:00, 17:00, 20:00
    # UTC æ—¶é—´: 00:00, 06:00, 09:00, 12:00
    - cron: '0 0,6,9,12 * * *'

    # --- ğŸ”´ ç–¯ç‹‚è¿½æ›´æ¨¡å¼ (é«˜é¢‘æŠ“å–) ---
    # åœºæ™¯ï¼šé’ˆå¯¹å‡Œæ™¨ 0-5 ç‚¹ç»“æŸçš„æ¯”èµ›ï¼Œåœ¨æ¸…æ™¨é«˜é¢‘å°è¯•æŠ“å– PID
    # é¢‘ç‡ï¼šæ¯ 15 åˆ†é’Ÿä¸€æ¬¡ (ç§æœ‰ä»“åº“å®‰å…¨é¢‘ç‡)
    
    # æ—¶æ®µ 1: åŒ—äº¬æ—¶é—´ 05:00 - 07:45 (UTC å‰ä¸€å¤© 21:00 - 23:45)
    - cron: '*/15 21-23 * * *'
    
    # æ—¶æ®µ 2: åŒ—äº¬æ—¶é—´ 08:00 - 10:45 (UTC å½“å¤© 00:00 - 02:45)
    - cron: '*/15 0-2 * * *'

  # å…è®¸æ‰‹åŠ¨å¼ºåˆ¶è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-data-factory:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai # è®¾å®šä¸ºåŒ—äº¬æ—¶é—´

    steps:
      - name: 1. æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: 2. è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: 3. å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f DataFactory/requirements.txt ]; then pip install -r DataFactory/requirements.txt; fi

      - name: 4. è¿è¡Œæ™ºèƒ½æ•°æ®å·¥å‚
        # ä¼ é€’ RUN_MODE ç¯å¢ƒå˜é‡
        run: |
          chmod +x update_all.sh
          # å¦‚æœæ˜¯å®šæ—¶è§¦å‘ï¼Œä½¿ç”¨æ™ºèƒ½æ¨¡å¼ï¼›å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå¼ºåˆ¶å…¨é‡è¿è¡Œ
          if [ "${{ github.event_name }}" == "schedule" ]; then
            export RUN_MODE="smart"
          else
            export RUN_MODE="force"
          fi
          ./update_all.sh

      - name: 5. æäº¤å¹¶æ¨é€ç»“æœ
        run: |
          git config --global user.name 'RedLens Bot'
          git config --global user.email 'danta-jz@users.noreply.github.com'
            
          # ğŸŸ¢ å…³é”®ï¼šå…ˆæ·»åŠ å˜åŠ¨çš„æ–‡ä»¶åˆ°æš‚å­˜åŒº
          git add matches.json migu_videos_complete.json matches_with_videos.json
            
          # æ£€æŸ¥æ˜¯å¦æœ‰çœŸæ­£çš„å†…å®¹å˜åŠ¨ï¼Œé˜²æ­¢ç©ºæäº¤æŠ¥é”™
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å‘ç°æ•°æ®å˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°èµ›ç¨‹æ•°æ®: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi