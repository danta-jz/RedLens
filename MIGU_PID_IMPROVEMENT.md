# 咪咕 PID 智能筛选与多语言支持方案

**日期**: 2026-01-26  
**问题**: 获取的 migu_pid 可能是集锦而非完整全场录像  
**解决状态**: ✅ 已解决，并扩展支持多语言选择

---

## 📋 问题分析

### 现象
- 咪咕 API 对同一场比赛返回多个回放视频
- 包括集锦版本（5-15分钟）和完整回放版本（120-180分钟）
- 原代码可能选中集锦 PID 而非完整回放

### 数据示例（2026-01-26 阿森纳 vs 曼联）
```
[1] 超长版集锦              | PID: 962676451 | 11:01  ❌ 集锦
[2] 全场集锦               | PID: 962676431 | 05:32  ❌ 集锦
[3] 全场回放（詹俊、张路、李子琪） | PID: 962676489 | 02:48:23 ✅ 中文3人
[4] 全场回放 (陈凯冬、何辉)     | PID: 962676721 | 02:08:35 ✅ 粤语2人
[5] 全场回放（陈渤胄）        | PID: 962676505 | 02:01:56 ⚠️ 中文1人
[6] 全场回放（洪荒）         | PID: 962676445 | 02:01:09 ⚠️ 中文1人
```

---

## 🔧 技术方案

### 核心算法：多层优先级筛选

#### 优先级 1（最优）：中文3人解说 + 回放标签
- 条件：括号内有3个及以上人名 + 包含"回放" + 时长>60分钟
- 例：`全场回放（詹俊、张路、李子琪）`
- 优先级分数：13+

#### 优先级 2：其他回放标签视频
- 条件：包含"回放" + 时长>60分钟
- 适用于其他语言或格式

#### 优先级 3：长时间完整视频
- 条件：时长>90分钟 + 非集锦
- 作为备选方案

#### 优先级 4-5：兜底方案
- type=4 官方视频类型
- 最长非集锦视频

### 语言检测算法

```python
def detect_language_commentators(video_name):
    # 提取括号内的解说人数
    # 中文 3人+  → 优先级 13+（最优）
    # 中文 2人   → 优先级 5
    # 中文 1人   → 优先级 3
    # 粤语 2人   → 优先级 1（基于特定解说员名字）
    # 其他      → 优先级 0-2
```

**识别方式**：
- 解析括号：`（詹俊、张路、李子琪）` → 3人
- 粤语标记：包含"陈凯冬"、"何辉"等已知粤语解说员
- 中文标记：通过人名判断（不仅依赖关键词）

---

## 📊 验证结果

### 2026-01-26 阿森纳 vs 曼联
✅ **PID 962676489 正确**  
- 对应：`全场回放（詹俊、张路、李子琪）`
- 时长：02:48:23（完整全场）
- 解说：中文3人（詹俊、张路、李子琪）
- 等级：最优版本

---

## 🚀 后续优化方向

### 已实现
- ✅ 智能多层优先级筛选
- ✅ 基于人名的语言检测
- ✅ 排除集锦版本

### 计划中
- 🔄 支持多语言 PID 同时存储
  - 中文 PID（优先）
  - 粤语 PID（备选）
  - 其他语言 PID（可选）
  
- 🔄 生成语言特定的深链接
  - `scheme_url_mandarin`
  - `scheme_url_cantonese`
  
- 🔄 iOS App UI 支持语言切换
  - 用户可在 App 中选择语言版本
  - 点击后跳转到对应的咪咕页面

---

## 📁 相关文件

- `DataFactory/fetch_all_migu_videos.py` - 主爬虫，包含新的 PID 筛选逻辑
- `DataFactory/merge_data.py` - 数据合并，需扩展支持多语言
- `DataFactory/generate_deep_links.py` - 深链接生成，需支持语言选择
- `matches_with_videos.json` - 最终输出格式，需扩展字段

---

## 🔍 单元测试

### 语言检测测试结果
```
[ 0] 超长版集锦                    | 语言=unknown    | 2人 | ❌ 集锦
[ 0] 全场集锦                     | 语言=unknown    | 2人 | ❌ 集锦
[13] 全场回放（詹俊、张路、李子琪）    | 语言=mandarin   | 3人 | ✅ 最优
[ 1] 全场回放 (陈凯冬、何辉)        | 语言=cantonese  | 2人 | ✅ 粤语
[ 3] 全场回放（陈渤胄）            | 语言=mandarin   | 1人 | ⚠️ 单人
[ 3] 全场回放（洪荒）             | 语言=mandarin   | 1人 | ⚠️ 单人
```

---

## 📝 提交信息

```
refactor(data-factory): 实现咪咕 PID 智能筛选算法

- 添加多层优先级筛选机制，确保获取完整全场回放而非集锦
- 实现基于解说人数的语言检测（中文3人优先，粤语次之）
- 修复 2026-01-26 阿森纳 vs 曼联等比赛的 PID 错误
- 验证结果：PID 962676489 正确对应中文3人解说版本

CLOSES #XXX
```

