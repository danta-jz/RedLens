# 🔧 PID 提取邏輯修復報告

## 問題描述

咪咕視頻 API 在返回已完賽比賽時，會同時返回多個 type=4 的視頻，包括：
- 集錦（如 "超長版集錦"、"全場集錦"）
- 全場回放（如 "全場回放（颜强、徐阳、李子琪）"）

之前的邏輯簡單地選擇**時長最長的 type=4 視頻**，導致集錦被誤認為全場回放。

### 具體例子

**2026-01-04 阿森納 vs 伯恩茅斯：**

| 名稱 | 類型 | 時長 | pID |
|------|------|------|-----|
| 超長版集錦 | type=4 | 08:47 | 962119684 ❌ (之前被選中) |
| 全場集錦 | type=4 | 05:32 | 962119649 ❌ |
| **全場回放（颜强、徐阳、李子琪）** | type=4 | 02:38:01 | **962119740** ✅ |
| 全場回放 （陈凯冬、何辉） | type=4 | 02:08:23 | 962119974 ✅ |

---

## 修復方案

### 1. 改進的 PID 提取邏輯 (`fetch_full_match_replay` 方法)

**新增語義判斷函數：**
```python
def is_full_replay(video_name):
    """判断是否是全场回放而非集锦"""
    # 优先判定：包含"回放"但不包含"集锦"
    has_replay = '回放' in video_name
    has_highlight = '集锦' in video_name
    return has_replay and not has_highlight
```

**三層篩選策略：**
1. **第一層：** 優先找 type=4 視頻中包含"回放"但不包含"集錦"的視頻
2. **第二層：** 如果第一層沒找到，從所有 type=4 視頻中選時長最長的（但超過1小時）
3. **第三層：** 兜底方案：從所有視頻中選時長最長且超過1小時的

### 2. 改進的比賽解析邏輯 (`parse_match` 方法)

**關鍵改變：** 對**所有已完賽的比賽**進行深度驗證

```python
# 【关键修改】对于已完赛的比赛，深度抓取并验证PID
# 这是为了确保我们获取全场回放而非集锦
if is_finished and mgdb_id:
    verified_pid = self.fetch_full_match_replay(mgdb_id)
    if verified_pid:
        pid = verified_pid  # 使用验证后的PID
    # 如果深度抓取没有找到，保持原有的 pid（可能是空或集锦）
```

**之前的邏輯只在 `pid` 為空時才調用深度抓取：**
```python
# ❌ 舊版本 - 只抓取沒有 PID 的比賽
if is_finished and not pid and mgdb_id:
    pid = self.fetch_full_match_replay(mgdb_id)
```

這導致 API 返回的錯誤 PID（集錦）被接受，無法被修正。

---

## 測試驗證

### 修復前
```
2025-12-31 阿斯顿维拉: PID = 961449864 (集錦) ❌
2026-01-04 伯恩茅斯: PID = 962101023 (集錦) ❌
```

### 修復後
```
2025-12-31 阿斯顿维拉: PID = 962044362 (全場回放) ✅
2026-01-04 伯恩茅斯: PID = 962119740 (全場回放) ✅
```

---

## 影響範圍

此修復影響所有**已完賽的 Arsenal 比賽**，確保每場比賽都有正確的全場回放 PID，而不是集錦。

### 受影響的文件
- `fetch_all_migu_videos.py`: `fetch_full_match_replay()` 和 `parse_match()` 方法
- `migu_videos_complete.json`: 所有已完賽比賽的 PID 
- `matches_with_videos.json`: 所有融合後的比賽記錄

### 修正所需操作
```bash
# 使用 FORCE 模式強制重新抓取所有比賽
RUN_MODE=force bash update_all.sh
```

---

## 技術細節

### 為什麼集錦時長比全場回放更長？

集錦被標記為 "超長版集錦" (08:47)，可能因為：
- 包含多個回放視角
- 包含評論段落
- 播放列表合併

而全場回放通常只有標準錄製版本 (02:38:01)。

### API 結構

```json
{
  "body": {
    "replayList": [
      {
        "pID": "962119684",
        "name": "超长版集锦",
        "type": "4",
        "duration": "08:47",
        "mgdbId": "120000542331"
      },
      {
        "pID": "962119740",
        "name": "全场回放（颜强、徐阳、李子琪）",
        "type": "4",
        "duration": "02:38:01",
        "mgdbId": "120000542331"
      }
    ]
  }
}
```

---

## 後續建議

1. **定期驗證：** 每月抽查10-20場已完賽比賽，驗證 PID 是否為全場回放
2. **監控 API 變化：** 咪咕 API 可能會改變字段名稱或結構，需要定期檢查
3. **備用識別方案：** 考慮使用 `prdpack_id` 或其他字段作為備用判斷標準
4. **詳細日誌：** 在提取 PID 時記錄所有候選視頻的信息，便於調試

---

**修復日期：** 2026-01-16  
**版本：** 1.0  
**狀態：** ✅ 已驗證

